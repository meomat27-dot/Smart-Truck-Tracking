<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة المهندس - نظام التتبع</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #1a237e; --bg: #f8f9fa; }
        body { margin: 0; padding: 0; background: var(--bg); font-family: system-ui; height: 100dvh; overflow: hidden; }
        .setup-container { height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .setup-card { background: white; width: 100%; max-width: 400px; padding: 35px 25px; border-radius: 28px; box-shadow: 0 15px 50px rgba(0,0,0,0.1); text-align: center; }
        .form-control-lg { border-radius: 14px; border: 2px solid #f0f0f0; font-size: 1.1rem; text-align: center; margin-bottom: 20px; }
        .btn-primary-custom { background: var(--primary); color: white; border-radius: 14px; padding: 12px; width: 100%; font-weight: 600; border: none; }
        #qrcode { display: flex; justify-content: center; margin-top: 25px; }
        #map { height: 100dvh; width: 100%; }
        #map-view { display: none; position: relative; }
        .floating-badge { position: absolute; top: 20px; right: 20px; z-index: 1000; background: white; padding: 10px 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: bold; }
    </style>
</head>
<body>

<div id="eng-panel" class="setup-container">
    <div class="setup-card">
        <h3 class="mb-4" style="color: var(--primary); font-weight: 800;">تتبع الشاحنة</h3>
        <input type="number" id="bus-id" class="form-control form-control-lg" placeholder="أدخل رقم الحافلة">
        <button class="btn btn-primary-custom" onclick="generateTracker()">توليد الباركود والمراقبة</button>
        <div id="qrcode"></div>
        <p id="wait-msg" class="mt-3 text-muted" style="display:none; font-size: 0.9rem;">بانتظار مسح السائق للباركود وبدء الرحلة...</p>
    </div>
</div>

<div id="map-view">
    <div class="floating-badge">الحافلة: <span id="active-bus">--</span></div>
    <div id="map"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<script>
    // الإعدادات الحقيقية من حسابك
    const firebaseConfig = {
        apiKey: "AIzaSyBtyCKVvy_9DcOUcStjkIP2gfFlrulFxAs",
        databaseURL: "https://the-smart-tracking-default-rtdb.firebaseio.com",
        projectId: "the-smart-tracking",
        authDomain: "the-smart-tracking.firebaseapp.com",
        appId: "1:1005270133021:web:1aed59c64c79a25565d9f4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map, marker, path;

    function generateTracker() {
        const id = document.getElementById('bus-id').value;
        if(!id) return;

        // صنع الرابط لصفحة السائق
        let driverUrl = window.location.origin + window.location.pathname.replace('index.html', '') + "driver.html?id=" + id;
        
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { 
            text: driverUrl, 
            width: 200, height: 200
        });
        
        document.getElementById('wait-msg').style.display = 'block';

        // مراقبة قاعدة البيانات لحظياً
        db.ref('trips/' + id).on('value', snap => {
            const data = snap.val();
            if(data && data.started === true) { renderMap(id, data); }
        });
    }

    function renderMap(id, data) {
        document.getElementById('eng-panel').style.display = 'none';
        document.getElementById('map-view').style.display = 'block';
        document.getElementById('active-bus').innerText = id;
        if(!map) {
            map = L.map('map', {zoomControl: false}).setView([data.lat, data.lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([data.lat, data.lng]).addTo(map);
            path = L.polyline([], {color: '#1a237e', weight: 4}).addTo(map);
        }
        const newPos = [data.lat, data.lng];
        marker.setLatLng(newPos);
        path.addLatLng(newPos);
        map.panTo(newPos);
    }
</script>
</body>
</html>