<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة المهندس</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #1a237e; --bg: #f8f9fa; }
        body { margin: 0; padding: 0; background: var(--bg); font-family: system-ui; height: 100dvh; overflow: hidden; }
        
        .setup-container { height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .setup-card { background: white; width: 100%; max-width: 400px; padding: 35px 25px; border-radius: 28px; box-shadow: 0 15px 50px rgba(0,0,0,0.1); text-align: center; }
        
        .form-control-lg { border-radius: 14px; border: 2px solid #f0f0f0; font-size: 1.3rem; height: 60px; text-align: center; margin-bottom: 20px; }
        .btn-generate { background: var(--primary); color: white; border: none; border-radius: 14px; height: 65px; font-size: 1.2rem; font-weight: 700; width: 100%; transition: 0.3s; 
            /* هنا المسافة تحت الزر */
            margin-bottom: 40px; 
        }
        .btn-generate:active { transform: scale(0.98); opacity: 0.9; }

        /* تنسيق حاوية الباركود لضمان المسافة والمركزية */
        #qrcode { display: flex; justify-content: center; align-items: center; min-height: 200px; }
        #qrcode img { border: 8px solid #fff; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }

        #map-view { position: fixed; inset: 0; display: none; }
        #map { height: 100%; width: 100%; }
        .floating-nav { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000; background: white; padding: 15px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="eng-panel" class="setup-container">
    <div class="setup-card">
        <h2 class="fw-bold mb-2">إدارة الصب</h2>
        <p class="text-muted mb-4">أدخل رقم الحافلة لإنشاء الرابط</p>
        
        <input type="number" id="bus-id" class="form-control form-control-lg" placeholder="1" inputmode="numeric">
        
        <button class="btn-generate shadow-sm" onclick="generateTrip()">توليد الباركود</button>
        
        <div id="qrcode"></div>
        
        <p id="wait-msg" class="mt-4 text-primary fw-bold" style="display:none; animation: fade 1.5s infinite;">
            بانتظار موافقة السائق...
        </p>
    </div>
</div>

<div id="map-view">
    <div class="floating-nav">
        <div class="fw-bold fs-5">حافلة رقم: <span id="active-bus" class="text-primary"></span></div>
        <button class="btn btn-danger rounded-pill px-4" onclick="location.reload()">إنهاء</button>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<script>
    // ضع بيانات Firebase هنا
    const firebaseConfig = { apiKey: "YOUR_KEY", databaseURL: "YOUR_URL" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let map, marker, path;

    function generateTrip() {
        const id = document.getElementById('bus-id').value;
        if(!id) return;

        // صنع الرابط لصفحة driver.html
        let driverUrl = window.location.origin + window.location.pathname.replace('index.html', '') + "driver.html?id=" + id;
        
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { 
            text: driverUrl, 
            width: 200, 
            height: 200,
            correctLevel : QRCode.CorrectLevel.H
        });
        
        document.getElementById('wait-msg').style.display = 'block';

        db.ref('trips/' + id).on('value', snap => {
            const data = snap.val();
            if(data && data.started === true) { renderMap(id, data); }
        });
    }

    function renderMap(id, data) {
        document.getElementById('eng-panel').style.display = 'none';
        document.getElementById('map-view').style.display = 'block';
        document.getElementById('active-bus').innerText = id;
        if(!map) {
            map = L.map('map', {zoomControl: false}).setView([data.lat, data.lng], 16);
            L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            marker = L.marker([data.lat, data.lng]).addTo(map);
            path = L.polyline([], {color: '#1a237e', weight: 6}).addTo(map);
        }
        marker.setLatLng([data.lat, data.lng]);
        path.addLatLng([data.lat, data.lng]);
        map.panTo([data.lat, data.lng]);
    }
</script>
</body>
</html>
