<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة المهندس - تتبع ذكي</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #1a237e; --bg: #f8f9fa; }
        body { margin: 0; padding: 0; background: var(--bg); font-family: system-ui; height: 100dvh; overflow: hidden; }
        .setup-container { height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .setup-card { background: white; width: 100%; max-width: 400px; padding: 35px 25px; border-radius: 28px; box-shadow: 0 15px 50px rgba(0,0,0,0.1); text-align: center; }
        .form-control-lg { border-radius: 14px; border: 2px solid #f0f0f0; font-size: 1.1rem; text-align: center; margin-bottom: 20px; }
        .btn-primary-custom { background: var(--primary); color: white; border-radius: 14px; padding: 12px; width: 100%; font-weight: 600; border: none; }
        
        #map-view { display: none; position: relative; height: 100vh; width: 100vw; }
        #map { height: 100%; width: 100%; filter: saturate(1.3); }
        
        .floating-badge { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; 
            background: white; padding: 12px 25px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
            font-weight: 800; color: var(--primary); border: 2px solid var(--primary);
        }

        /* تنسيق الأيقونة لتتحرك بنعومة */
        .truck-wrapper { transition: all 0.5s ease-out; }
        #qrcode img { margin: 0 auto; }
    </style>
</head>
<body>

<div id="eng-panel" class="setup-container">
    <div class="setup-card">
        <h3 class="mb-4" style="color: var(--primary); font-weight: 800;">نظام التتبع الذكي</h3>
        <input type="number" id="bus-id" class="form-control form-control-lg" placeholder="أدخل رقم الحافلة">
        <button class="btn btn-primary-custom" onclick="generateTracker()">توليد الباركود والمراقبة</button>
        <div id="qrcode" class="mt-4"></div>
        <p id="wait-msg" class="mt-3 text-muted" style="display:none;">بانتظار مسح السائق للباركود...</p>
    </div>
</div>

<div id="map-view">
    <div class="floating-badge">جاري تتبع الحافلة: <span id="active-bus">--</span></div>
    <div id="map"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBtyCKVvy_9DcOUcStjkIP2gfFlrulFxAs",
        databaseURL: "https://the-smart-tracking-default-rtdb.firebaseio.com",
        projectId: "the-smart-tracking",
        authDomain: "the-smart-tracking.firebaseapp.com",
        appId: "1:1005270133021:web:1aed59c64c79a25565d9f4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map, marker, path;
    let lastPos = null;

    function generateTracker() {
        const id = document.getElementById('bus-id').value;
        if(!id) { alert("أدخل رقم الحافلة أولاً"); return; }

        // إنشاء الرابط لصفحة السائق (تأكد من تسمية ملف السائق driver.html)
        let driverUrl = window.location.origin + window.location.pathname.replace('index.html', '') + "driver.html?id=" + id;
        
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { text: driverUrl, width: 200, height: 200 });
        document.getElementById('wait-msg').style.display = 'block';
// الاستماع لقاعدة البيانات
        db.ref('trips/' + id).on('value', snap => {
            const data = snap.val();
            if(data && data.started === true) { renderMap(id, data); }
        });
    }

    function renderMap(id, data) {
        document.getElementById('eng-panel').style.display = 'none';
        document.getElementById('map-view').style.display = 'block';
        document.getElementById('active-bus').innerText = id;

        const currentPos = [data.lat, data.lng];

        if(!map) {
            // إعداد الخريطة لأول مرة
            map = L.map('map', { zoomControl: false }).setView(currentPos, 17);
            
            // ثيم الخريطة (فاتح ومنعش مثل ويز)
            L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

            // أيقونة الشاحنة
            const truckIcon = L.divIcon({
                className: 'truck-wrapper',
                html: <div id="truck-img" style="transform: rotate(0deg); transition: transform 0.5s;">
                        <img src="https://cdn-icons-png.flaticon.com/512/3063/3063822.png" style="width: 45px;">
                       </div>,
                iconSize: [45, 45],
                iconAnchor: [22, 22]
            });

            marker = L.marker(currentPos, { icon: truckIcon }).addTo(map);
            path = L.polyline([], { color: '#3498db', weight: 6, opacity: 0.5 }).addTo(map);
        }

        // حساب الزاوية للدوران
        if (lastPos) {
            const angle = Math.atan2(data.lng - lastPos.lng, data.lat - lastPos.lat) * 180 / Math.PI;
            const truckEl = document.getElementById('truck-img');
            if (truckEl) truckEl.style.transform = rotate(${angle}deg);
        }

        // تحديث الموقع والمسار
        marker.setLatLng(currentPos);
        path.addLatLng(currentPos);
        
        // تحريك الكاميرا بنعومة وراء الشاحنة
        map.panTo(currentPos, { animate: true, duration: 1.0 });

        lastPos = { lat: data.lat, lng: data.lng };
    }
</script>
</body>
</html>